# Vercel MCP Server Deployment & Authentication Guide

## Problem

Your MCP server at `/api/mcp/[transport]` returns **HTTP 401 Authentication Required** when accessed by external MCP clients.

### Root Cause

Vercel's **Deployment Protection** (Vercel Authentication) is enabled on your deployment, blocking all unauthenticated requests including your MCP API endpoints.

### Error Details

```
HTTP 401: Authentication Required
HTML Response: Vercel authentication page with SSO redirect
```

---

## ⚠️ Important: Configuration Limitations

**Deployment protection settings CANNOT be configured via `vercel.json`** - they must be managed through the Vercel Dashboard UI.

---

## Solutions (Choose the Best Option for Your Use Case)

### Option 1: Disable Deployment Protection (Recommended for Public MCP Servers)

**Best for:** Open-source projects, development, public APIs

**Steps:**

1. Go to [Vercel Dashboard](https://vercel.com/dashboard)
2. Select your project
3. Navigate to **Settings → Deployment Protection**
4. Choose one of:
   - **Disabled** - No protection on any deployment
   - **Only Preview Deployments** - Production is public, previews are protected
5. Click **Save**

**Configuration:**
```
Dashboard → Settings → Deployment Protection → Disabled
```

**Pros:**
- ✅ Simplest solution
- ✅ Works immediately with all MCP clients
- ✅ No code changes needed
- ✅ No client configuration required

**Cons:**
- ⚠️ Entire deployment becomes public (not just MCP endpoints)
- ⚠️ Not suitable if you need to protect your web UI

---

### Option 2: Protection Bypass for Automation (Recommended for Controlled Access)

**Best for:** Private deployments, controlled access, CI/CD pipelines

**Steps:**

1. In Vercel Dashboard → **Settings → Deployment Protection**
2. Enable **Protection Bypass for Automation**
3. Copy the generated bypass secret
4. The secret is also available as environment variable: `VERCEL_AUTOMATION_BYPASS_SECRET`

**MCP Client Configuration:**

Add the bypass header to your MCP client config:

```json
{
  "mcpServers": {
    "lyrifind": {
      "url": "https://your-app.vercel.app/api/mcp",
      "headers": {
        "x-vercel-protection-bypass": "your-bypass-secret-here"
      }
    }
  }
}
```

**Alternative: Query Parameter (if headers not supported):**

```
https://your-app.vercel.app/api/mcp?x-vercel-protection-bypass=your-secret
```

**Pros:**
- ✅ Keeps deployment fully protected
- ✅ Only authorized clients can access
- ✅ Purpose-built for automation
- ✅ Secret can be rotated/revoked

**Cons:**
- ⚠️ Requires MCP client to support custom headers or query params
- ⚠️ Secret management required
- ⚠️ Not all MCP clients support custom headers

---

### Option 3: Deployment Protection Exceptions (Enterprise Only)

**Best for:** Enterprise customers who need granular control

**Requirements:**
- Enterprise plan OR Pro plan with Advanced Deployment Protection add-on

**Steps:**

1. Navigate to **Settings → Deployment Protection**
2. Click **Add Domain** in the **Deployment Protection Exceptions** section
3. Enter the preview domain you want to make public
4. Confirm by re-entering the domain and typing "unprotect my domain"

**Example Exception:**
```
lyri-find-git-main-naboberys-projects.vercel.app
```

**Pros:**
- ✅ Granular control over which deployments are public
- ✅ Rest of deployments remain protected
- ✅ Centralized management

**Cons:**
- ⚠️ Requires Enterprise plan or add-on
- ⚠️ Only works for specific domains (not path-based)

---

### Option 4: OAuth Authentication (Production-Grade Security)

**Best for:** Production deployments requiring authentication

**Implementation:**

#### Step 1: Install dependencies

```bash
pnpm add jose # For JWT verification
```

#### Step 2: Create auth verification

Create `apps/web/lib/mcp/auth.ts`:

```typescript
import { NextRequest } from 'next/server';
import { jwtVerify, createRemoteJWKSet } from 'jose';

const JWKS_URL = process.env.OAUTH_JWKS_URL || 'https://your-auth.com/.well-known/jwks.json';
const JWKS = createRemoteJWKSet(new URL(JWKS_URL));

export async function verifyMcpToken(
  req: NextRequest,
  bearerToken?: string
): Promise<{ token: string; scopes: string[]; clientId: string } | undefined> {
  if (!bearerToken) {
    return undefined;
  }

  try {
    const { payload } = await jwtVerify(bearerToken, JWKS, {
      issuer: process.env.OAUTH_ISSUER,
      audience: process.env.OAUTH_AUDIENCE,
    });

    return {
      token: bearerToken,
      scopes: (payload.scopes as string[]) || ['read:songs'],
      clientId: payload.sub || 'unknown',
    };
  } catch (error) {
    console.error('Token verification failed:', error);
    return undefined;
  }
}
```

#### Step 3: Update MCP handler

Update `apps/web/app/api/mcp/[transport]/route.ts`:

```typescript
import { createMcpHandler, withMcpAuth } from 'mcp-handler';
import { verifyMcpToken } from '@/lib/mcp/auth';
// ... other imports

const baseHandler = createMcpHandler(
  // ... your existing server configuration
);

// Wrap with authentication
const handler = withMcpAuth(baseHandler, verifyMcpToken, {
  required: true,
  requiredScopes: ['read:songs'],
  resourceMetadataPath: '/.well-known/oauth-protected-resource',
});

export { handler as GET, handler as POST, handler as DELETE };
```

#### Step 4: Create OAuth metadata endpoint

Create `apps/web/app/.well-known/oauth-protected-resource/route.ts`:

```typescript
import { protectedResourceHandler } from 'mcp-handler';

const handler = protectedResourceHandler({
  authServerUrls: [
    process.env.OAUTH_ISSUER || 'https://your-auth-server.com',
  ],
});

export { handler as GET };
```

#### Step 5: Environment variables

Add to your `.env` and Vercel:

```bash
OAUTH_ISSUER=https://your-auth-server.com
OAUTH_AUDIENCE=your-api-audience
OAUTH_JWKS_URL=https://your-auth-server.com/.well-known/jwks.json
```

**Pros:**
- ✅ Industry-standard authentication
- ✅ Fine-grained access control
- ✅ Supports scopes and permissions
- ✅ Token-based, no shared secrets

**Cons:**
- ⚠️ Requires OAuth provider setup
- ⚠️ More complex implementation
- ⚠️ MCP client must support OAuth

---

## Recommendation Matrix

| Use Case | Recommended Solution | Why |
|----------|---------------------|-----|
| Public/Open-source MCP server | Option 1: Disable Protection | Simplest, no barriers |
| Development/Testing | Option 1: Disable Protection | Quick setup, easy testing |
| Private MCP server | Option 2: Automation Bypass | Balance of security & simplicity |
| CI/CD Integration | Option 2: Automation Bypass | Purpose-built for automation |
| Production API | Option 4: OAuth | Standards-compliant security |
| Enterprise Multi-tenant | Option 3 + 4: Exceptions + OAuth | Granular control |

---

## Current Project Configuration

### Files Updated

**`apps/web/vercel.json`:**
```json
{
  "$schema": "https://openapi.vercel.sh/vercel.json",
  "framework": "nextjs",
  "functions": {
    "app/api/mcp/[transport]/route.ts": {
      "maxDuration": 60
    },
    "app/api/chat/route.ts": {
      "maxDuration": 60
    }
  }
}
```

**`turbo.json`:**
```json
{
  "globalEnv": [
    "GENIUS_ACCESS_TOKEN",
    "GROQ_API_KEY"
  ]
}
```

### Vercel Dashboard Actions Required

Choose one:

**✅ Recommended: Option 1 (Disable Protection)**
1. Dashboard → Settings → Deployment Protection
2. Set to **Disabled** or **Only Preview Deployments**
3. Save

**OR**

**✅ Recommended: Option 2 (Automation Bypass)**
1. Dashboard → Settings → Deployment Protection
2. Enable **Protection Bypass for Automation**
3. Copy the secret and configure your MCP client

---

## Testing Your MCP Server

### Local Testing

```bash
# Start dev server
pnpm dev

# In another terminal, test with MCP inspector
pnpm dlx @modelcontextprotocol/inspector@latest http://localhost:3000/api/mcp
```

### Production Testing (after applying fix)

```bash
# Test tools/list endpoint
curl https://your-app.vercel.app/api/mcp \
  -H "Content-Type: application/json" \
  -d '{"jsonrpc": "2.0", "method": "tools/list", "id": 1}'
```

**Expected Response:**
```json
{
  "jsonrpc": "2.0",
  "id": 1,
  "result": {
    "tools": [
      {"name": "identify_song", ...},
      {"name": "get_song_details", ...}
    ]
  }
}
```

---

## Troubleshooting

### Still Getting 401 After Disabling Protection

1. **Clear deployment cache:** Force a new deployment
2. **Check all deployments:** Protection settings apply per-deployment
3. **Wait for propagation:** Changes may take 1-2 minutes

### MCP Client Can't Connect

1. **Verify URL format:** Should end with `/api/mcp` not `/api/mcp/[transport]`
2. **Check HTTPS:** Vercel requires HTTPS for production
3. **Test with curl:** Verify the endpoint responds

### Protection Bypass Not Working

1. **Verify secret:** Check it matches `VERCEL_AUTOMATION_BYPASS_SECRET`
2. **Check header syntax:** Must be exact: `x-vercel-protection-bypass`
3. **Try query param:** Use `?x-vercel-protection-bypass=secret` instead

---

## Security Best Practices

### For Public MCP Servers
- ✅ Rate limit your endpoints
- ✅ Monitor usage and logs
- ✅ Implement input validation
- ✅ Use Vercel Firewall rules

### For Private MCP Servers
- ✅ Use Option 2 (Automation Bypass) minimum
- ✅ Rotate secrets regularly
- ✅ Implement OAuth for production
- ✅ Use scoped tokens
- ✅ Enable audit logging

---

## References

- [Vercel Deployment Protection](https://vercel.com/docs/deployment-protection)
- [Protection Bypass for Automation](https://vercel.com/docs/deployment-protection/methods-to-bypass-deployment-protection/protection-bypass-automation)
- [Deployment Protection Exceptions](https://vercel.com/docs/deployment-protection/methods-to-bypass-deployment-protection/deployment-protection-exceptions)
- [Deploy MCP Servers to Vercel](https://vercel.com/docs/mcp/deploy-mcp-servers-to-vercel)
- [mcp-handler Package](https://www.npmjs.com/package/mcp-handler)
- [MCP Authorization Spec](https://spec.modelcontextprotocol.io/specification/2024-11-05/authorization/)
- [Solving MCP Authentication with Vercel](https://neon.com/blog/solving-mcp-with-vercel-and-better-auth)

---

## Quick Start Checklist

- [ ] Decide which option fits your use case (see Recommendation Matrix)
- [ ] Go to Vercel Dashboard → Settings → Deployment Protection
- [ ] Apply chosen configuration (Option 1 or 2 recommended)
- [ ] Deploy your application to Vercel
- [ ] Set **Root Directory** to `apps/web` in project settings
- [ ] Test the MCP endpoint with curl or MCP inspector
- [ ] Configure your MCP client (Claude Desktop, etc.)
- [ ] Monitor Vercel logs for any issues

---

**Need help?** Check the [Vercel Community](https://community.vercel.com/) or [MCP Documentation](https://modelcontextprotocol.io/)
